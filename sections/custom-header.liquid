<link rel="stylesheet" href="{{ 'custom-header.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-search.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-menu-drawer.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-cart-notification.css' | asset_url }}" media="print" onload="this.media='all'">

{%- if settings.predictive_search_enabled -%}
  <link rel="stylesheet" href="{{ 'component-price.css' | asset_url }}" media="print" onload="this.media='all'">
{%- endif -%}

{%- style -%}
  :root {
    --custom-header-padding-top: {{ section.settings.padding_top }}px;
    --custom-header-padding-bottom: {{ section.settings.padding_bottom }}px;
    --custom-header-padding-horizontal: {{ section.settings.padding_horizontal }}px;

    --custom-header-logo-width: {{ section.settings.logo_width }}px;
    --custom-header-logo-text-size: {{ section.settings.logo_text_size }}px;
    --custom-header-logo-x: {{ section.settings.logo_position_x }}px;
    --custom-header-logo-y: {{ section.settings.logo_position_y }}px;

    --custom-header-menu-spacing: {{ section.settings.menu_spacing }}px;
    --custom-header-menu-weight: {% if section.settings.menu_bold %}700{% else %}400{% endif %};
    --custom-header-menu-hover-color: {{ section.settings.menu_hover_color }};
    --custom-header-menu-active-color: {{ section.settings.menu_active_color }};
    --custom-header-menu-x: {{ section.settings.menu_position_x }}px;
    --custom-header-menu-y: {{ section.settings.menu_position_y }}px;

    --custom-header-cart-bubble-color: {{ section.settings.cart_bubble_color }};
  }

  /* Wie im Dawn-Header: die Section mit Klasse .section-header wird sticky */
  .section-header {
    position: sticky; /* Safari-Fix & Basis für Sticky */
    top: 0;
    z-index: 50;
  }
{%- endstyle -%}

<script src="{{ 'cart-notification.js' | asset_url }}" defer="defer"></script>

{%- comment -%}
  Dawn-Mechanik: wir nutzen <sticky-header> als Wrapper und
  geben data-sticky-type mit (hier "always").
{%- endcomment -%}
<sticky-header
  data-sticky-type="always"
  class="custom-header-wrapper section-header color-{{ section.settings.color_scheme }} gradient{% if section.settings.show_border %} header-wrapper--border-bottom{% endif %}"
>
  <header class="custom-header page-width{% if section.settings.desktop_menu_type == 'burger' %} custom-header--burger-menu{% endif %}">
    
    {%- if section.settings.menu != blank -%}
      {% render 'custom-header-mobile' %}
    {%- endif -%}

    <!-- Logo -->
    <div class="custom-header__logo-wrapper">
      <a href="{{ routes.root_url }}" class="custom-header__logo-link">
        {%- if section.settings.logo_type == 'image' and section.settings.logo_image != blank -%}
          <img 
            src="{{ section.settings.logo_image | image_url: width: 600 }}" 
            alt="{{ shop.name | escape }}"
            class="custom-header__logo-image"
            width="{{ section.settings.logo_width }}"
            height="auto"
            loading="eager"
          >
        {%- else -%}
          <span class="custom-header__logo-text">
            {%- if section.settings.logo_text != blank -%}
              {{ section.settings.logo_text }}
            {%- else -%}
              {{ shop.name }}
            {%- endif -%}
          </span>
        {%- endif -%}
      </a>
    </div>

    <!-- Navigation Menu (Desktop) -->
    {%- if section.settings.menu != blank -%}
      <nav class="custom-header__nav">
        <ul class="custom-header__menu">
          {%- for link in section.settings.menu.links -%}
            <li>
              <a 
                href="{{ link.url }}" 
                class="custom-header__menu-link{% if link.active or link.child_active %} custom-header__menu-link--active{% endif %}"
                {% if link.current %}aria-current="page"{% endif %}
              >
                {{ link.title | escape }}
              </a>
            </li>
          {%- endfor -%}
        </ul>
      </nav>
    {%- endif -%}

    <!-- Icons -->
    <div class="custom-header__icons">
      
      {%- if section.settings.enable_search -%}
        {% render 'header-search', input_id: 'Search-Custom-Header' %}
      {%- endif -%}

      {%- if section.settings.enable_account and shop.customer_accounts_enabled -%}
        <a
          href="{%- if customer -%}{{ routes.account_url }}{%- else -%}{{ routes.account_login_url }}{%- endif -%}"
          class="custom-header__icon custom-header__icon--account link focus-inset"
          rel="nofollow"
        >
          <span class="svg-wrapper">{{ 'icon-account.svg' | inline_asset_content }}</span>
          <span class="visually-hidden">
            {%- if customer -%}
              {{ 'customer.account_fallback' | t }}
            {%- else -%}
              {{ 'customer.log_in' | t }}
            {%- endif -%}
          </span>
        </a>
      {%- endif -%}

      {%- if section.settings.enable_cart -%}
        <a href="{{ routes.cart_url }}" class="custom-header__icon custom-header__icon--cart link focus-inset" id="custom-cart-icon">
          <span class="svg-wrapper">
            <!-- Einkaufswagen-Icon inline -->
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="20" r="1.6"></circle>
              <circle cx="18" cy="20" r="1.6"></circle>
              <path d="M3 3h2l2.2 11.2a2 2 0 0 0 2 1.6h7.6a2 2 0 0 0 2-1.6L21 7H6"></path>
            </svg>
          </span>
          <span class="visually-hidden">{{ 'templates.cart.cart' | t }}</span>

          {%- if cart != empty and cart.item_count > 0 -%}
            <div class="cart-count-bubble">
              {%- if cart.item_count < 100 -%}
                <span aria-hidden="true">{{ cart.item_count }}</span>
              {%- endif -%}
              <span class="visually-hidden">{{ 'sections.header.cart_count' | t: count: cart.item_count }}</span>
            </div>
          {%- endif -%}
        </a>
      {%- endif -%}

    </div>
  </header>
</sticky-header>

{%- if settings.cart_type == 'notification' -%}
  {%- render 'cart-notification', color_scheme: section.settings.color_scheme -%}
{%- endif -%}

{%- comment -%}
  Original Dawn-Logik für Sticky Header (unverändert übernommen).
{%- endcomment -%}
{% javascript %}
  class StickyHeader extends HTMLElement {
    constructor() {
      super();
    }

    connectedCallback() {
      this.header = document.querySelector('.section-header');
      this.headerIsAlwaysSticky =
        this.getAttribute('data-sticky-type') === 'always' ||
        this.getAttribute('data-sticky-type') === 'reduce-logo-size';
      this.headerBounds = {};

      this.setHeaderHeight();

      window.matchMedia('(max-width: 990px)').addEventListener('change', this.setHeaderHeight.bind(this));

      if (this.headerIsAlwaysSticky) {
        this.header.classList.add('shopify-section-header-sticky');
      }

      this.currentScrollTop = 0;
      this.preventReveal = false;
      this.predictiveSearch = this.querySelector('predictive-search');

      this.onScrollHandler = this.onScroll.bind(this);
      this.hideHeaderOnScrollUp = () => (this.preventReveal = true);

      this.addEventListener('preventHeaderReveal', this.hideHeaderOnScrollUp);
      window.addEventListener('scroll', this.onScrollHandler, false);

      this.createObserver();
    }

    setHeaderHeight() {
      document.documentElement.style.setProperty('--header-height', `${this.header.offsetHeight}px`);
    }

    disconnectedCallback() {
      this.removeEventListener('preventHeaderReveal', this.hideHeaderOnScrollUp);
      window.removeEventListener('scroll', this.onScrollHandler);
    }

    createObserver() {
      let observer = new IntersectionObserver((entries, observer) => {
        this.headerBounds = entries[0].intersectionRect;
        observer.disconnect();
      });

      observer.observe(this.header);
    }

    onScroll() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      if (this.predictiveSearch && this.predictiveSearch.isOpen) return;

      if (scrollTop > this.currentScrollTop && scrollTop > this.headerBounds.bottom) {
        this.header.classList.add('scrolled-past-header');
        if (this.preventHide) return;
        requestAnimationFrame(this.hide.bind(this));
      } else if (scrollTop < this.currentScrollTop && scrollTop > this.headerBounds.bottom) {
        this.header.classList.add('scrolled-past-header');
        if (!this.preventReveal) {
          requestAnimationFrame(this.reveal.bind(this));
        } else {
          window.clearTimeout(this.isScrolling);

          this.isScrolling = setTimeout(() => {
            this.preventReveal = false;
          }, 66);

          requestAnimationFrame(this.hide.bind(this));
        }
      } else if (scrollTop <= this.headerBounds.top) {
        this.header.classList.remove('scrolled-past-header');
        requestAnimationFrame(this.reset.bind(this));
      }

      this.currentScrollTop = scrollTop;
    }

    hide() {
      if (this.headerIsAlwaysSticky) return;
      this.header.classList.add('shopify-section-header-hidden', 'shopify-section-header-sticky');
      this.closeMenuDisclosure();
      this.closeSearchModal();
    }

    reveal() {
      if (this.headerIsAlwaysSticky) return;
      this.header.classList.add('shopify-section-header-sticky', 'animate');
      this.header.classList.remove('shopify-section-header-hidden');
    }

    reset() {
      if (this.headerIsAlwaysSticky) return;
      this.header.classList.remove('shopify-section-header-hidden', 'shopify-section-header-sticky', 'animate');
    }

    closeMenuDisclosure() {
      this.disclosures = this.disclosures || this.header.querySelectorAll('header-menu');
      this.disclosures.forEach((disclosure) => disclosure.close());
    }

    closeSearchModal() {
      this.searchModal = this.searchModal || this.header.querySelector('details-modal');
      this.searchModal.close(false);
    }
  }

  customElements.define('sticky-header', StickyHeader);
{% endjavascript %}

{% schema %}
{
  "name": "Custom Header",
  "class": "section-header",
  "settings": [
    { "type": "header", "content": "Logo Einstellungen" },
    { "type": "select", "id": "logo_type", "label": "Logo Typ",
      "options": [{"value":"text","label":"Text"},{"value":"image","label":"Bild"}],
      "default": "text"
    },
    { "type": "image_picker", "id": "logo_image", "label": "Logo Bild" },
    { "type": "range", "id": "logo_width", "min": 50, "max": 300, "step": 10, "unit": "px", "label": "Logo Breite", "default": 150 },
    { "type": "text", "id": "logo_text", "label": "Logo Text", "default": "Mein Shop" },
    { "type": "range", "id": "logo_text_size", "min": 16, "max": 48, "step": 2, "unit": "px", "label": "Logo Text Größe", "default": 24 },
    { "type": "range", "id": "logo_position_x", "min": -200, "max": 200, "step": 5, "unit": "px", "label": "Logo Position X", "default": 0 },
    { "type": "range", "id": "logo_position_y", "min": -100, "max": 100, "step": 5, "unit": "px", "label": "Logo Position Y", "default": 0 },

    { "type": "header", "content": "Menü Einstellungen" },
    { "type": "link_list", "id": "menu", "label": "Menü auswählen", "default": "main-menu" },
    { "type": "checkbox", "id": "menu_bold", "label": "Menü fettgedruckt", "default": false },
    { "type": "range", "id": "menu_spacing", "min": 10, "max": 50, "step": 5, "unit": "px", "label": "Abstand zwischen Menüpunkten", "default": 20 },
    { "type": "color", "id": "menu_hover_color", "label": "Menü Hover Farbe", "default": "#000000" },
    { "type": "color", "id": "menu_active_color", "label": "Aktiver Menüpunkt Farbe", "default": "#000000" },
    { "type": "range", "id": "menu_position_x", "min": -200, "max": 200, "step": 5, "unit": "px", "label": "Menü Position X", "default": 0 },
    { "type": "range", "id": "menu_position_y", "min": -100, "max": 100, "step": 5, "unit": "px", "label": "Menü Position Y", "default": 0 },

    { "type": "header", "content": "Icon Einstellungen" },
    { "type": "checkbox", "id": "enable_search", "label": "Suche Icon anzeigen", "default": true },
    { "type": "checkbox", "id": "enable_account", "label": "Benutzerkonto Icon anzeigen", "default": true },
    { "type": "checkbox", "id": "enable_cart", "label": "Warenkorb Icon anzeigen", "default": true },
    { "type": "color", "id": "cart_bubble_color", "label": "Warenkorb Bubble Farbe", "default": "#000000" },

    { "type": "header", "content": "Allgemeine Einstellungen" },
    { "type": "color_scheme", "id": "color_scheme", "label": "Farbschema", "default": "scheme-1" },
    { "type": "checkbox", "id": "show_border", "label": "Untere Trennlinie anzeigen", "default": true },
    { "type": "range", "id": "padding_top", "min": 0, "max": 50, "step": 2, "unit": "px", "label": "Padding Oben", "default": 20 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 50, "step": 2, "unit": "px", "label": "Padding Unten", "default": 20 },
    { "type": "range", "id": "padding_horizontal", "min": 0, "max": 100, "step": 5, "unit": "px", "label": "Padding Links/Rechts", "default": 50 }
  ]
}
{% endschema %}
