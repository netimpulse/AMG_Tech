{% comment %}
====================================================================================
  1. CSS-STILE
====================================================================================
{% endcomment %}
{{ 'custom-header.css' | asset_url | stylesheet_tag }}

<style>
  /* KORRIGIERT: Erzwingt, dass der Header die volle Bildschirmbreite einnimmt,
     unabhängig von übergeordneten Containern. */
  .custom-header-section{
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100vw;
    z-index: 1000;
    background: var(--header-bg-color);
    box-shadow: 0 1px 3px rgba(0,0,0,.1);
  }

  /* KORRIGIERT: Stellt sicher, dass der Inhalt innerhalb des Headers
     wieder eine maximale Breite hat und zentriert ist. */
  .custom-header__container{
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
    padding: var(--padding-vertical) var(--padding-horizontal);
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: var(--header-min-height);
  }

  /* Logo + Zurück zusammen */
  .custom-header__brand{
    display:flex; align-items:center;
    gap: var(--brand-gap, 16px);
    transform: translate(var(--logo-offset-x, 0), var(--logo-offset-y, 0));
    transition: transform .3s ease;
  }

  .custom-header__logo{ display:flex; align-items:center; }
  .custom-header__logo-img{ height:var(--logo-height); width:auto; display:block; }
  .custom-header__logo-text{ font-weight:700; text-decoration:none; line-height:1; }

  /* Zurück-Pfeil inline */
  .custom-header__back{
    display:inline-flex; align-items:center; gap:.5rem;
    text-decoration:none; line-height:1;
    color:var(--back-text-color);
    font-size:var(--back-font-size);
    font-family:var(--back-font-family);
    font-style:var(--back-font-style);
    font-weight:var(--back-font-weight);
    transition:color .3s ease, transform .2s ease;
    white-space:nowrap;
  }
  .custom-header__back:hover{ color:var(--back-hover-color); transform:translateY(-1px); }
  .custom-header__back-icon{ width:1em; height:1em; flex:0 0 auto; }

  /* Wrapper für alle rechten Elemente */
  .custom-header__right-side {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transform: translate(var(--menu-offset-x, 0), var(--menu-offset-y, 0));
    transition: transform .3s ease;
  }

  /* Navigation rechts */
  .custom-header__nav-wrapper{ display:flex; align-items:center; gap:1.5rem; }
  .custom-header__nav{ display:flex; gap:2rem; align-items:center; }

  .custom-header__nav-link{
    text-decoration:none; color:var(--nav-text-color);
    font-size:var(--nav-font-size); position:relative; padding-bottom:5px;
    transition:color .3s ease;
    font-family:var(--nav-font-family);
    font-style:var(--nav-font-style);
    font-weight:var(--nav-font-weight);
  }
  .custom-header__nav-link:hover{ color:var(--nav-hover-color); }
  .custom-header__nav-link::after{
    content:''; position:absolute; bottom:0; left:0; width:0; height:2px;
    background:var(--nav-hover-color); transition:width .3s ease;
  }
  .custom-header__nav-link:hover::after,
  .custom-header__nav-link.active::after{ width:100%; }
  .custom-header__nav-link.active{ color:var(--nav-hover-color); }

  .custom-header__contact-btn{
    display:inline-block; padding:.6rem 1.6rem; border-radius:12px;
    text-decoration:none; font-weight:500;
    color:var(--btn-text-color); background:var(--btn-bg-color);
    border:1px solid transparent;
    transition:background .3s ease, color .3s ease, box-shadow .3s ease, transform .2s ease;
  }
  .custom-header__contact-btn:hover{
    color:var(--btn-hover-text-color); background:var(--btn-hover-bg-color);
    transform:translateY(-2px); box-shadow:0 4px 14px rgba(0,0,0,.12);
  }

  .custom-header__mobile-toggle{ display:none; flex-direction:column; gap:4px; background:none; border:none; cursor:pointer; padding:8px; }
  .custom-header__mobile-toggle span{ width:24px; height:2px; background:var(--nav-text-color); transition:all .3s ease; }

  /* Responsive */
  @media (max-width:990px){
    .custom-header__nav-wrapper{ display:none; }
    .custom-header__mobile-toggle{ display:flex; }
    .custom-header__right-side { gap: 0.5rem; }
  }

  /* Mobile Drawer (rechts) */
  html.no-scroll{ overflow:hidden; }
  .custom-header-section .custom-header__overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); opacity:0; pointer-events:none; transition:opacity .3s ease; z-index:1000; }
  .custom-header-section.is-drawer-open .custom-header__overlay{ opacity:1; pointer-events:auto; }
  .custom-header__drawer{ position:fixed; top:0; right:0; height:100vh; width:min(86vw, 380px); background:var(--header-bg-color); box-shadow:-8px 0 24px rgba(0,0,0,.12); transform:translate3d(105%,0,0); transition:transform .3s ease, visibility .3s ease; z-index:1001; display:flex; flex-direction:column; padding:24px 24px 0; overflow:hidden; visibility:hidden; pointer-events:none; }
  .custom-header-section.is-drawer-open .custom-header__drawer{ transform:translate3d(0,0,0); visibility:visible; pointer-events:auto; }
  .custom-header__drawer-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .custom-header__drawer-title{ font-weight:700; font-size:18px; margin:0; }
  .custom-header__drawer-close{ background:none; border:none; cursor:pointer; padding:8px; line-height:0; }
  .custom-header__drawer-nav{ flex:1 1 auto; display:flex; flex-direction:column; gap:8px; padding:12px 0 24px; overflow:auto; -webkit-overflow-scrolling:touch; }
  .custom-header__drawer-link{ text-decoration:none; color:var(--nav-text-color); font-family:var(--nav-font-family); font-style:var(--nav-font-style); font-weight:var(--nav-font-weight); font-size:18px; padding:10px 0; border-bottom:1px solid rgba(0,0,0,.06); transition:color .3s ease; }
  .custom-header__drawer-link:hover, .custom-header__drawer-link.active { color:var(--nav-hover-color); }
  .custom-header__drawer-cta{ position:sticky; bottom:0; background:var(--header-bg-color); padding:12px 0 calc(12px + env(safe-area-inset-bottom, 0)); border-top:1px solid rgba(0,0,0,.06); box-shadow:0 -4px 10px rgba(0,0,0,.04); }
  .custom-header__drawer-cta .custom-header__contact-btn{ width:100%; text-align:center; }
  .custom-header-section.is-drawer-open .custom-header__mobile-toggle span:nth-child(1){ transform:translateY(6px) rotate(45deg); }
  .custom-header-section.is-drawer-open .custom-header__mobile-toggle span:nth-child(2){ opacity:0; }
  .custom-header-section.is-drawer-open .custom-header__mobile-toggle span:nth-child(3){ transform:translateY(-6px) rotate(-45deg); }
  .custom-header__mobile-toggle span{ transform-origin:center; }
  @media (min-width:991px){ .custom-header__overlay, .custom-header__drawer{ display:none !important; } }

  /* CSS-Variablen aus dem Schema */
  .custom-header-section-{{ section.id }}{
    --header-bg-color: {{ section.settings.background_color }};
    --padding-vertical: {{ section.settings.padding_vertical }}px;
    --padding-horizontal: {{ section.settings.padding_horizontal }}px;
    --logo-height: {{ section.settings.logo_height | default: 40 }}px;
    --header-min-height: calc(var(--logo-height) + (var(--padding-vertical) * 2));
    --brand-gap: 16px;
    --logo-offset-x: {{ section.settings.logo_offset_x }}px;
    --logo-offset-y: {{ section.settings.logo_offset_y }}px;
    --menu-offset-x: {{ section.settings.menu_offset_x }}px;
    --menu-offset-y: {{ section.settings.menu_offset_y }}px;
    --nav-font-family: {{ section.settings.nav_font.family }}, {{ section.settings.nav_font.fallback_families }};
    --nav-font-style: {{ section.settings.nav_font.style }};
    --nav-font-weight: {% if section.settings.nav_font_bold %}bold{% else %}{{ section.settings.nav_font.weight }}{% endif %};
    --nav-text-color: {{ section.settings.nav_text_color }};
    --nav-hover-color: {{ section.settings.nav_hover_color }};
    --nav-font-size: {{ section.settings.nav_font_size }}px;
    --btn-text-color: {{ section.settings.button_text_color }};
    --btn-bg-color: {{ section.settings.button_bg_color }};
    --btn-hover-text-color: {{ section.settings.button_hover_text_color }};
    --btn-hover-bg-color: {{ section.settings.button_hover_bg_color }};
    --back-font-family: {{ section.settings.back_font.family }}, {{ section.settings.back_font.fallback_families }};
    --back-font-style: {{ section.settings.back_font.style }};
    --back-font-weight: {% if section.settings.back_font_bold %}bold{% else %}{{ section.settings.back_font.weight }}{% endif %};
    --back-text-color: {{ section.settings.back_text_color }};
    --back-hover-color: {{ section.settings.back_hover_color }};
    --back-font-size: {{ section.settings.back_font_size }}px;
  }

  /* Statische Hilfs-Stile */
  #sticky-header-{{ section.id }}{ top:0; z-index:1000; width:100%; }
  @media (min-width: 991px){ .custom-header__cta-mobile{ display:none !important; } }
  @media (max-width: 990px){ .custom-header__cta-mobile{ display:flex; } }
</style>


{% comment %}
====================================================================================
  2. HTML-STRUKTUR
====================================================================================
{% endcomment %}
<header id="sticky-header-{{ section.id }}" class="custom-header-section custom-header-section-{{ section.id }}">
  <div class="custom-header__container">

    <div class="custom-header__brand">
      <a href="{{ shop.url }}" class="custom-header__logo">
        {% if section.settings.logo %}
          {% liquid
            assign h = section.settings.logo_height | default: 40
            assign w = h | times: section.settings.logo.aspect_ratio | round
          %}
          <img src="{{ section.settings.logo | image_url: width: w }}"
               alt="{{ section.settings.logo.alt | default: shop.name }}"
               class="custom-header__logo-img"
               height="{{ h }}" width="{{ w }}"
               loading="lazy">
        {% else %}
          <span class="custom-header__logo-text"
                style="color: {{ section.settings.logo_color }}; font-size: {{ section.settings.logo_font_size }}px;">
            {{ section.settings.logo_text | default: shop.name }}
          </span>
        {% endif %}
      </a>

      {% if section.settings.show_back_button %}
        {% if section.settings.back_link != blank or section.settings.back_label != blank %}
          <a href="{{ section.settings.back_link | default: shop.url }}" class="custom-header__back" aria-label="{{ section.settings.back_label | default: 'Zurück' }}">
            <svg class="custom-header__back-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            {% if section.settings.back_label != blank %}
              <span class="custom-header__back-label">{{ section.settings.back_label }}</span>
            {% endif %}
          </a>
        {% endif %}
      {% endif %}
    </div>

    <div class="custom-header__right-side">
      <div class="custom-header__nav-wrapper">
        <nav class="custom-header__nav" role="navigation">
          {%- for link in section.settings.menu.links -%}
            <a href="{{ link.url }}" class="custom-header__nav-link {% if link.active %}active{% endif %}">{{ link.title }}</a>
          {%- endfor -%}
        </nav>
        {%- if section.settings.button_text != blank and section.settings.button_link != blank -%}
          <a href="{{ section.settings.button_link }}" class="custom-header__contact-btn">{{ section.settings.button_text }}</a>
        {%- endif -%}
      </div>

      {% if section.settings.button_text != blank and section.settings.button_link != blank %}
        <a href="{{ section.settings.button_link }}" class="custom-header__contact-btn custom-header__cta-mobile">
          {{ section.settings.button_text }}
        </a>
      {% endif %}

      <button class="custom-header__mobile-toggle" aria-label="Menü öffnen" aria-controls="mobile-drawer-{{ section.id }}" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="custom-header__overlay" data-drawer-overlay hidden></div>
    <aside id="mobile-drawer-{{ section.id }}" class="custom-header__drawer" aria-hidden="true" tabindex="-1">
      <div class="custom-header__drawer-header">
        <p class="custom-header__drawer-title">{{ section.settings.logo_text | default: shop.name }}</p>
        <button class="custom-header__drawer-close" aria-label="Menü schließen">
          <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <nav class="custom-header__drawer-nav" role="navigation" aria-label="Mobile Navigation">
        {%- for link in section.settings.menu.links -%}
          <a href="{{ link.url }}" class="custom-header__drawer-link {% if link.active %}active{% endif %}">{{ link.title }}</a>
        {%- endfor -%}
      </nav>
      {%- if section.settings.button_text != blank and section.settings.button_link != blank -%}
        <div class="custom-header__drawer-cta">
          <a href="{{ section.settings.button_link }}" class="custom-header__contact-btn" style="width:100%; text-align:center;">
            {{ section.settings.button_text }}
          </a>
        </div>
      {%- endif -%}
    </aside>
  </div>
</header>


{% comment %}
====================================================================================
  3. JAVASCRIPT
====================================================================================
{% endcomment %}
<script>
  (function(){
    const header = document.getElementById('sticky-header-{{ section.id }}');
    if(!header) return;
    const setHeaderPadding = () => {
      let headerHeight = header.offsetHeight;
      const announcementBar = document.querySelector('.announcement-bar, [data-announcement-bar]');
      if (announcementBar) {
        header.style.top = `${announcementBar.offsetHeight}px`;
        headerHeight += announcementBar.offsetHeight;
      } else {
        header.style.top = '0px';
      }
      document.documentElement.style.setProperty('--header-height', `${headerHeight}px`);
      document.body.style.paddingTop = `${headerHeight}px`;
    };
    setHeaderPadding();
    window.addEventListener('resize', setHeaderPadding);
    if('ResizeObserver' in window) new ResizeObserver(setHeaderPadding).observe(header);
  })();

  (function(){
    const header = document.getElementById('sticky-header-{{ section.id }}');
    if (!header) return;
    const toggle = header.querySelector('.custom-header__mobile-toggle');
    const drawer = document.getElementById('mobile-drawer-{{ section.id }}');
    const overlay = header.querySelector('[data-drawer-overlay]');
    const closeBtn = header.querySelector('.custom-header__drawer-close');

    const openDrawer = () => {
      if(!drawer) return;
      header.classList.add('is-drawer-open');
      drawer.setAttribute('aria-hidden', 'false');
      toggle?.setAttribute('aria-expanded', 'true');
      if (overlay) overlay.hidden = false;
      document.documentElement.classList.add('no-scroll');
    };

    const closeDrawer = () => {
      if(!drawer) return;
      header.classList.remove('is-drawer-open');
      drawer.setAttribute('aria-hidden', 'true');
      toggle?.setAttribute('aria-expanded', 'false');
      document.documentElement.classList.remove('no-scroll');
      setTimeout(() => { if (overlay) overlay.hidden = true; }, 300);
    };

    toggle?.addEventListener('click', () => header.classList.contains('is-drawer-open') ? closeDrawer() : openDrawer());
    overlay?.addEventListener('click', closeDrawer);
    closeBtn?.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e) => e.key === 'Escape' && closeDrawer());
  })();
</script>


{% comment %}
====================================================================================
  4. SCHEMA
====================================================================================
{% endcomment %}
{% schema %}
{
  "name": "Sticky Header (Custom)",
  "class": "shopify-section-header",
  "settings": [
    { "type": "color", "id": "background_color", "label": "Hintergrundfarbe", "default": "#ffffff" },
    { "type": "range", "id": "padding_vertical", "label": "Padding Oben/Unten", "min": 0, "max": 50, "step": 1, "default": 16, "unit": "px" },
    { "type": "range", "id": "padding_horizontal", "label": "Padding Links/Rechts", "min": 0, "max": 100, "step": 1, "default": 24, "unit": "px" },

    { "type": "header", "content": "Zurück-Pfeil" },
    { "type": "checkbox", "id": "show_back_button", "label": "Zurück-Button anzeigen", "default": true },
    { "type": "url", "id": "back_link", "label": "Link für Zurück-Pfeil" },
    { "type": "text", "id": "back_label", "label": "Text neben Pfeil (optional)", "default": "Zurück" },
    { "type": "font_picker", "id": "back_font", "label": "Schriftart", "default": "sans-serif" },
    { "type": "checkbox", "id": "back_font_bold", "label": "Fett", "default": false },
    { "type": "color", "id": "back_text_color", "label": "Farbe", "default": "#374151" },
    { "type": "color", "id": "back_hover_color", "label": "Farbe (Hover)", "default": "#4ade80" },
    { "type": "range", "id": "back_font_size", "label": "Schriftgröße", "min": 12, "max": 28, "step": 1, "default": 16, "unit": "px" },

    { "type": "header", "content": "Logo" },
    { "type": "image_picker", "id": "logo", "label": "Logo Bild" },
    { "type": "range", "id": "logo_height", "label": "Logo-Höhe", "min": 20, "max": 120, "step": 1, "default": 40, "unit": "px" },
    { "type": "text", "id": "logo_text", "label": "Logo Text (Fallback)", "default": "Mein Shop" },
    { "type": "color", "id": "logo_color", "label": "Logo Textfarbe", "default": "#1e40af" },
    { "type": "range", "id": "logo_font_size", "label": "Logo Schriftgröße", "min": 16, "max": 48, "step": 1, "default": 24, "unit": "px" },
    { "type": "range", "id": "logo_offset_x", "label": "Position Horizontal (X)", "min": -50, "max": 49, "step": 1, "default": 0, "unit": "px" },
    { "type": "range", "id": "logo_offset_y", "label": "Position Vertikal (Y)", "min": -50, "max": 49, "step": 1, "default": 0, "unit": "px" },

    { "type": "header", "content": "Navigation & Menü" },
    { "type": "link_list", "id": "menu", "label": "Menü auswählen", "default": "main-menu" },
    { "type": "font_picker", "id": "nav_font", "label": "Schriftart", "default": "sans-serif" },
    { "type": "checkbox", "id": "nav_font_bold", "label": "Fett", "default": false },
    { "type": "color", "id": "nav_text_color", "label": "Textfarbe", "default": "#374151" },
    { "type": "color", "id": "nav_hover_color", "label": "Hover-Farbe", "default": "#4ade80" },
    { "type": "range", "id": "nav_font_size", "label": "Schriftgröße", "min": 12, "max": 24, "step": 1, "default": 16, "unit": "px" },
    { "type": "range", "id": "menu_offset_x", "label": "Position Horizontal (X)", "min": -50, "max": 49, "step": 1, "default": 0, "unit": "px" },
    { "type": "range", "id": "menu_offset_y", "label": "Position Vertikal (Y)", "min": -50, "max": 49, "step": 1, "default": 0, "unit": "px" },

    { "type": "header", "content": "Kontakt Button" },
    { "type": "text", "id": "button_text", "label": "Button Text", "default": "Kontakt" },
    { "type": "url", "id": "button_link", "label": "Button Link" },
    { "type": "color", "id": "button_text_color", "label": "Textfarbe", "default": "#ffffff" },
    { "type": "color", "id": "button_bg_color", "label": "Hintergrund", "default": "#4ade80" },
    { "type": "color", "id": "button_hover_text_color", "label": "Textfarbe (Hover)", "default": "#ffffff" },
    { "type": "color", "id": "button_hover_bg_color", "label": "Hintergrund (Hover)", "default": "#22c55e" }
  ],
  "presets": [{ "name": "Sticky Header (Custom)" }]
}
{% endschema %}
